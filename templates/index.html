<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Certificate Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 font-sans text-gray-800">
    <div class="container mx-auto p-6">
      <h1 class="text-4xl font-semibold text-center text-indigo-600 mb-6">
        Generate Certificate
      </h1>

      <!-- Certificate Generation Form -->
      <form
        action="/generate"
        method="POST"
        id="certificate-form"
        class="space-y-6 bg-white p-6 rounded-lg shadow-lg"
      >
        <div class="space-y-4">
          <div class="flex flex-col">
            <label for="name" class="font-medium text-gray-700"
              >Your Name</label
            >
            <input
              type="text"
              name="name"
              id="name"
              placeholder="Enter your name"
              required
              class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>

          <div class="flex flex-col">
            <label for="year" class="font-medium text-gray-700"
              >Select Year</label
            >
            <select
              name="year"
              id="year"
              required
              class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              <option value="1">1st Year</option>
              <option value="2">2nd Year</option>
              <option value="3">3rd Year</option>
              <option value="4">4th Year</option>
            </select>
          </div>

          <div class="flex flex-col">
            <label for="template" class="font-medium text-gray-700"
              >Select Template(s)</label
            >
            <div id="template-checkboxes" class="space-y-2">
              <!-- Checkboxes will be populated based on selected year -->
            </div>
          </div>

          <!-- Display Total Points -->
          <div class="flex flex-col">
            <label class="font-medium text-gray-700">Total Points</label>
            <input
              type="text"
              id="total-points"
              value="0"
              disabled
              class="p-3 border border-gray-300 rounded-md bg-gray-100"
            />
          </div>

          <!-- Generate Button -->
          <button
            type="submit"
            class="w-full py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition"
          >
            Generate Certificates
          </button>
        </div>
      </form>

      <!-- Loader Spinner -->
      <div
        id="loading-spinner"
        class="hidden flex justify-center items-center space-x-2"
      >
        <div
          class="w-8 h-8 border-4 border-t-4 border-indigo-600 rounded-full animate-spin"
        ></div>
        <span class="text-indigo-600 font-semibold">Generating...</span>
      </div>

      <!-- Display Generated Files -->
      <div id="generated-files" class="mt-8 space-y-4">
        <!-- Links to generated files will be shown here -->
      </div>
    </div>

    <script>
      // Update templates dynamically based on year selection
      document.getElementById("year").addEventListener("change", function () {
        const year = this.value;
        const templateCheckboxesContainer = document.getElementById(
          "template-checkboxes"
        );

        // Clear previous checkboxes
        templateCheckboxesContainer.innerHTML = "";

        // Fetch templates for the selected year
        fetch(`/get-templates/${year}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.templates.length > 0) {
              // Populate checkboxes for templates
              data.templates.forEach((template) => {
                const checkboxWrapper = document.createElement("div");
                checkboxWrapper.classList.add(
                  "flex",
                  "items-center",
                  "space-x-2"
                );

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = template.name;
                checkbox.classList.add("template-checkbox");
                checkbox.dataset.points = template.points;

                const label = document.createElement("label");
                label.textContent = `${template.name} (${template.points} points)`;

                checkboxWrapper.appendChild(checkbox);
                checkboxWrapper.appendChild(label);

                templateCheckboxesContainer.appendChild(checkboxWrapper);
              });
            } else {
              const noTemplateMessage = document.createElement("p");
              noTemplateMessage.textContent =
                "No templates available for this year.";
              templateCheckboxesContainer.appendChild(noTemplateMessage);
            }
          });
      });

      // Calculate total points when templates are selected
      document
        .getElementById("certificate-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          // Show loader spinner
          document.getElementById("loading-spinner").classList.remove("hidden");

          // Calculate total points based on selected checkboxes
          let totalPoints = 0;
          const selectedCheckboxes = document.querySelectorAll(
            ".template-checkbox:checked"
          );

          selectedCheckboxes.forEach((checkbox) => {
            const points = parseInt(checkbox.dataset.points);
            totalPoints += points;
          });

          // Update total points display
          document.getElementById("total-points").value = totalPoints;

          // Get the selected template names
          const selectedTemplates = Array.from(selectedCheckboxes).map(
            (checkbox) => checkbox.value
          );

          // Create FormData to send selected templates to the backend
          const formData = new FormData(this);
          selectedTemplates.forEach((template) =>
            formData.append("template", template)
          );

          fetch("/generate", {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              if (response.ok) {
                // Trigger the download of the ZIP file
                return response.blob();
              }
              throw new Error("Failed to generate certificates.");
            })
            .then((blob) => {
              // Hide loader spinner
              document
                .getElementById("loading-spinner")
                .classList.add("hidden");

              // Trigger file download
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "certificates.zip";
              a.click();

              // Display "Download Started" message
              const generatedFilesDiv =
                document.getElementById("generated-files");
              generatedFilesDiv.innerHTML = `<p class="text-indigo-600 font-semibold">Download Started...</p>`;
            })
            .catch((error) => {
              // Hide loader spinner
              document
                .getElementById("loading-spinner")
                .classList.add("hidden");

              alert("An error occurred: " + error.message);
            });
        });
    </script>
  </body>
</html>
